<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Amigo Secreto Virtual 🎁</title>

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">

  <div id="root" class="w-full max-w-md mx-auto"></div>

  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>

  <script>
    // 🔹 Configuración de tu proyecto Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBnbMA899xhAT0wYrpUcKa1H0v3qzOPs6A",
      authDomain: "amigo-secreto-9e366.firebaseapp.com",
      projectId: "amigo-secreto-9e366",
      storageBucket: "amigo-secreto-9e366.firebasestorage.app",
      messagingSenderId: "134510716985",
      appId: "1:134510716985:web:68f528a74abe082e6045e8"
    };

    // 🔹 Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    window.db = db;
  </script>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // =============================================================
    // COMPONENTE #1: VISTA DEL ORGANIZADOR (CREAR JUEGO)
    // =============================================================
    function AdminView() {
      const [players, setPlayers] = useState([]);
      const [name, setName] = useState("");
      const [loading, setLoading] = useState(false);
      const [createdGameId, setCreatedGameId] = useState(null); // Guarda el ID del juego creado

      // Función para agregar jugador a la lista local
      const addPlayer = () => {
        if (name.trim() && !players.includes(name.trim())) {
          setPlayers([...players, name.trim()]);
          setName("");
        }
      };
      
      // Función para quitar jugador de la lista local
      const removePlayer = (playerToRemove) => {
        setPlayers(players.filter(p => p !== playerToRemove));
      };
      
      // Genera un código de 6 letras/números
      const generateGameId = () => {
         return Math.random().toString(36).substring(2, 8).toUpperCase();
      };

      // Función para crear el juego y hacer el sorteo
      const createGame = async () => {
        if (players.length < 2) return alert("Necesitas al menos 2 jugadores");
        setLoading(true);

        const newGameId = generateGameId();

        // --- Lógica del sorteo (robusta) ---
        let givers = [...players];
        let receivers = [...players];
        const finalAssignments = {};

        for (const giver of givers) {
          let possibleReceivers = receivers.filter(r => r !== giver);
          
          if (possibleReceivers.length === 0 && receivers.length === 1 && receivers[0] === giver) {
            // Caso especial: el último se saca a sí mismo. Intercambiamos.
            const randomGiver = players[0]; // Tomamos al primero de la lista
            const randomGiverTarget = finalAssignments[randomGiver];
            
            finalAssignments[randomGiver] = giver; // El primero ahora le da al último
            finalAssignments[giver] = randomGiverTarget; // El último le da al amigo del primero
            
            receivers = []; // Se acabó
          } else {
            let receiver = possibleReceivers[Math.floor(Math.random() * possibleReceivers.length)];
            finalAssignments[giver] = receiver;
            receivers = receivers.filter(r => r !== receiver); // Quitar de la lista de receptores
          }
        }
        // --- Fin del sorteo ---

        try {
          // Usamos un 'batch' de Firebase para guardar todo en una sola operación
          const batch = db.batch();
          
          // 1. Creamos la información del juego
          batch.set(db.collection("juegos").doc(newGameId), { 
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              playerCount: players.length
          });
          
          // 2. Creamos los documentos de cada participante
          for (const [giver, receiver] of Object.entries(finalAssignments)) {
            const playerDocRef = db.collection("juegos").doc(newGameId).collection("participantes").doc(giver);
            batch.set(playerDocRef, {
              nombre: giver,
              leTocaA: receiver,
              revelado: false // <-- importante: 'false' significa que no ha sido visto
            });
          }
          
          await batch.commit(); // Ejecutamos todas las operaciones
          setLoading(false);
          setCreatedGameId(newGameId); // Mostramos la pantalla de éxito

        } catch (error) {
          console.error("Error al crear el juego:", error);
          alert("Hubo un error al crear el juego. Intenta de nuevo.");
          setLoading(false);
        }
      };
      
      // Si el juego ya se creó, muestra la pantalla de éxito
      if (createdGameId) {
        const shareLink = `${window.location.href.split('?')[0]}?juego=${createdGameId}`;
        
        return (
          <div className="bg-white shadow-xl rounded-2xl p-6 w-full">
            <h1 className="text-2xl font-bold text-center mb-4">🎁 Amigo Secreto Virtual</h1>
            <div className="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-lg mb-4">
              <p className="font-bold">¡Sorteo creado exitosamente!</p>
              <p>Código del juego: <span className="font-mono text-lg">{createdGameId}</span></p>
            </div>
            
            <p className="font-semibold mb-2">Paso 2: Comparte este link con todos los participantes</p>
            <div className="flex gap-2">
              <input 
                type="text" 
                readOnly 
                value={shareLink} 
                className="border p-2 flex-grow rounded-lg bg-gray-100"
              />
              <button 
                onClick={() => navigator.clipboard.writeText(shareLink)}
                className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                Copiar
              </button>
            </div>
            
            <a href={shareLink} className="block w-full text-center bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 mt-4">
                Continuar para ver mi asignación
            </a>
            
             <div className="mt-6 text-sm text-gray-600">
                <h3 className="font-bold mb-2">¿Cómo funciona?</h3>
                <ol className="list-decimal list-inside space-y-1">
                    <li>El organizador agrega todos los nombres y crea el sorteo (¡listo!).</li>
                    <li>Se comparte el link con todos los participantes.</li>
                    <li>Cada persona abre el link, selecciona su nombre y descubre a quién le toca.</li>
                    <li>Una vez que un nombre es usado, queda bloqueado.</li>
                    <li>¡Nadie puede ver la asignación de otra persona!</li>
                </ol>
             </div>
          </div>
        );
      }
      
      // Si el juego no se ha creado, muestra el formulario de administrador
      return (
        <div className="bg-white shadow-xl rounded-2xl p-6 w-full">
          <h1 className="text-2xl font-bold text-center mb-4">🎁 Amigo Secreto Virtual</h1>
          <p className="text-center text-gray-600 mb-4">Paso 1: Agrega a los participantes y crea el juego.</p>
          
          <div className="flex gap-2 mb-4">
            <input
              className="border p-2 flex-grow rounded-lg"
              type="text"
              placeholder="Nombre del participante"
              value={name}
              onChange={(e) => setName(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && addPlayer()}
            />
            <button
              onClick={addPlayer}
              className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
            >
              Agregar
            </button>
          </div>

          <div className="mb-4 min-h-[100px]">
            <h2 className="font-semibold">👥 Jugadores: ({players.length})</h2>
            <ul className="list-disc ml-6 mt-2">
              {players.map((p) => (
                <li key={p} className="flex justify-between items-center">
                  {p}
                  <button 
                    onClick={() => removePlayer(p)} 
                    className="text-red-500 hover:text-red-700 text-xs">
                    (quitar)
                  </button>
                </li>
              ))}
            </ul>
          </div>

          <button
            onClick={createGame}
            disabled={loading || players.length < 2}
            className="bg-green-600 text-white w-full py-2 rounded-lg hover:bg-green-700 disabled:opacity-50"
          >
            {loading ? "Creando juego..." : `🎲 Crear Sorteo (${players.length} jugadores)`}
          </button>
        </div>
      );
    }

    // =============================================================
    // COMPONENTE #2: VISTA DEL PARTICIPANTE (VER ASIGNACIÓN)
    // =============================================================
    function ParticipantView({ gameId }) {
      const [unclaimedPlayers, setUnclaimedPlayers] = useState([]);
      const [selectedName, setSelectedName] = useState("");
      const [myAssignment, setMyAssignment] = useState(null); // Aquí se guarda el resultado
      
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);

      // Cargar la lista de jugadores que NO han visto su asignación
      useEffect(() => {
        try {
          const unsubscribe = db.collection("juegos").doc(gameId).collection("participantes")
            .where("revelado", "==", false) // <-- Solo trae los nombres no reclamados
            .onSnapshot(snapshot => {
              if (snapshot.empty) {
                setError("Este juego no existe o ya todos han visto su nombre.");
              }
              const playerList = snapshot.docs.map(doc => doc.data().nombre);
              setUnclaimedPlayers(playerList);
              setLoading(false);
            }, (err) => {
               setError("No se pudo cargar el juego. Verifica el código.");
               setLoading(false);
            });
          return () => unsubscribe();
        } catch (err) {
            setError("El código del juego no es válido.");
            setLoading(false);
        }
      }, [gameId]);

      // Función para revelar el amigo secreto
      const revealMyName = async () => {
        if (!selectedName) return alert("Por favor, selecciona tu nombre de la lista.");
        setLoading(true);

        const playerDocRef = db.collection("juegos").doc(gameId).collection("participantes").doc(selectedName);

        // Usamos una "transacción" para evitar que dos personas reclamen el mismo nombre
        try {
          await db.runTransaction(async (transaction) => {
            const doc = await transaction.get(playerDocRef);
            if (!doc.exists) {
              throw "¡Tu nombre no se encontró en este juego!";
            }
            if (doc.data().revelado) {
              throw "¡Este nombre ya fue seleccionado por alguien más!";
            }
            
            // Si todo está bien, actualizamos el nombre como "revelado"
            transaction.update(playerDocRef, { revelado: true });
            return doc.data().leTocaA;
          })
          .then((targetName) => {
            setMyAssignment(targetName); // Guardamos el resultado
            setLoading(false);
          });
          
        } catch (e) {
          setError(typeof e === 'string' ? e : "Hubo un error al consultar. Intenta de nuevo.");
          setLoading(false);
        }
      };

      // Si ya se reveló, muestra el resultado
      if (myAssignment) {
        return (
          <div className="bg-white shadow-xl rounded-2xl p-6 w-full text-center">
             <h1 className="text-2xl font-bold text-center mb-4">🎁 Amigo Secreto</h1>
             <p className="text-lg text-gray-700">¡Hola, <span className="font-bold">{selectedName}</span>!</p>
             <p className="text-lg text-gray-700 mt-4">Te toca darle un regalo a...</p>
             
             <div className="my-6 p-4 bg-blue-100 rounded-lg">
                <p className="text-4xl font-bold text-blue-700">{myAssignment}</p>
             </div>
             
             <p className="text-sm text-gray-500">¡Que no se te olvide!</p>
          </div>
        );
      }
      
      // Muestra un error si lo hay
      if (error) {
           return (
             <div className="bg-white shadow-xl rounded-2xl p-6 w-full text-center">
                <h1 className="text-2xl font-bold text-red-600 mb-4">Error</h1>
                <p className="text-gray-700">{error}</p>
                <a href={window.location.href.split('?')[0]} className="block text-blue-600 mt-4">Volver a la página principal</a>
             </div>
           );
      }
      
      // Muestra la pantalla de carga
      if (loading) {
          return (
             <div className="bg-white shadow-xl rounded-2xl p-6 w-full text-center">
                <p className="text-lg text-gray-700">Cargando juego...</p>
             </div>
           );
      }

      // Muestra el formulario para seleccionar el nombre
      return (
        <div className="bg-white shadow-xl rounded-2xl p-6 w-full">
          <h1 className="text-2xl font-bold text-center mb-4">🎁 Amigo Secreto</h1>
          <p className="text-center text-gray-600 mb-4">Selecciona tu nombre de la lista para descubrir quién te tocó.</p>
          
          <select 
            className="border p-2 w-full rounded-lg mb-4"
            value={selectedName}
            onChange={(e) => setSelectedName(e.target.value)}
          >
            <option value="">-- Por favor, elige tu nombre --</option>
            {unclaimedPlayers.map(p => (
              <option key={p} value={p}>{p}</option>
            ))}
          </select>
          
          <button
            onClick={revealMyName}
            disabled={loading || !selectedName}
            className="bg-red-600 text-white w-full py-2 rounded-lg hover:bg-red-700 disabled:opacity-50"
          >
            {loading ? "..." : "¡Revelar mi amigo secreto!"}
          </button>
        </div>
      );
    }
    
    // =============================================================
    // COMPONENTE PRINCIPAL (DECIDE QUÉ VISTA MOSTRAR)
    // =============================================================
    function App() {
      const [gameId, setGameId] = useState(null);

      // Al cargar la página, revisa si hay un código de juego en el link
      useEffect(() => {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('juego');
        if (id) {
          setGameId(id);
        }
      }, []);

      // Si hay un 'gameId' en el link, muestra la vista de participante
      if (gameId) {
        return <ParticipantView gameId={gameId} />;
      }
      
      // Si no, muestra la vista de administrador para crear un juego
      return <AdminView />;
    }

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>
