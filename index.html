<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Amigo Secreto Remoto 🎁</title>

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

  <div id="root" class="w-full max-w-md"></div>

  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>

  <script>
    // 🔹 Configuración de tu proyecto Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBnbMA899xhAT0wYrpUcKa1H0v3qzOPs6A",
      authDomain: "amigo-secreto-9e366.firebaseapp.com",
      projectId: "amigo-secreto-9e366",
      storageBucket: "amigo-secreto-9e366.firebasestorage.app",
      messagingSenderId: "134510716985",
      appId: "1:134510716985:web:68f528a74abe082e6045e8"
    };

    // 🔹 Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 🔹 Hacer la base de datos accesible globalmente
    window.db = db;
  </script>

  <script type="text/babel">

    const { useState, useEffect } = React;

    function App() {
      const [players, setPlayers] = useState([]);
      const [name, setName] = useState("");
      const [assignments, setAssignments] = useState({});
      const [loading, setLoading] = useState(false);

      // 🔹 Cargar jugadores desde Firestore
      useEffect(() => {
        const unsubscribe = db.collection("jugadores").onSnapshot(snapshot => {
          const data = snapshot.docs.map(doc => doc.data().nombre);
          setPlayers(data);
        });
        return () => unsubscribe();
      }, []);

      // 
      // ⭐ AQUÍ ESTÁ EL CÓDIGO MODIFICADO ⭐
      // 
      // 🔹 Agregar jugador (Mejorado: evita duplicados)
      const addPlayer = async () => {
        if (!name.trim()) return;
        
        // Usamos el nombre como ID para que no se pueda repetir
        try {
          const nombreLimpio = name.trim();
          await db.collection("jugadores").doc(nombreLimpio).set({ nombre: nombreLimpio });
          setName("");
        } catch (error) {
          console.error("Error al agregar jugador:", error);
          alert("Hubo un error al agregarte. Intenta de nuevo.");
        }
      };
      // 
      // ⭐ FIN DEL CÓDIGO MODIFICADO ⭐
      // 

      // 🔹 Hacer el sorteo
      const shuffle = async () => {
        if (players.length < 2) return alert("Necesitas al menos 2 jugadores");
        setLoading(true);

        // Mezclar
        let shuffled = [...players].sort(() => Math.random() - 0.5);
        const newAssignments = {};
        players.forEach((p, i) => {
          newAssignments[p] = shuffled[(i + 1) % shuffled.length];
        });

        // Guardar en Firestore
        await db.collection("sorteos").doc("asignaciones").set(newAssignments);
        setAssignments(newAssignments);
        setLoading(false);
        alert("🎉 Sorteo realizado correctamente!");
      };

      // 🔹 Ver asignaciones si existen
      useEffect(() => {
        db.collection("sorteos").doc("asignaciones").get().then(doc => {
          if (doc.exists) setAssignments(doc.data());
        });
      }, []);

      return (
        <div className="bg-white shadow-xl rounded-2xl p-6 w-full">
          <h1 className="text-2xl font-bold text-center mb-4">🎁 Amigo Secreto Remoto</h1>

          <div className="flex gap-2 mb-4">
            <input
              className="border p-2 flex-grow rounded-lg"
              type="text"
              placeholder="Tu nombre"
              value={name}
              onChange={(e) => setName(e.target.value)}
            />
            <button
              onClick={addPlayer}
              className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
            >
              Agregar
            </button>
          </div>

          <div className="mb-4">
            <h2 className="font-semibold">👥 Jugadores:</h2>
            <ul className="list-disc ml-6">
              {players.map((p, i) => (
                <li key={i}>{p}</li>
              ))}
            </ul>
          </div>

          <button
            onClick={shuffle}
            disabled={loading}
            className="bg-green-600 text-white w-full py-2 rounded-lg hover:bg-green-700 mb-3"
          >
            {loading ? "Sorteando..." : "🎲 Hacer Sorteo"}
          </button>

          {Object.keys(assignments).length > 0 && (
            <div className="mt-4">
              <h2 className="font-semibold text-lg mb-2">🔒 Asignaciones (solo organizador)</h2>
              <ul className="list-none">
                {Object.entries(assignments).map(([a, b]) => (
                  <li key={a} className="p-1 border-b">{a} → {b}</li>
                ))}
              </ul>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>
