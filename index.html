<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Amigo Secreto Virtual 🎁</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <div id="root" class="w-full max-w-md mx-auto"></div>

  <script>
    // 🔹 Configuración de tu proyecto Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBnbMA899xhAT0wYrpUcKa1H0v3qzOPs6A",
      authDomain: "amigo-secreto-9e366.firebaseapp.com",
      projectId: "amigo-secreto-9e366",
      storageBucket: "amigo-secreto-9e366.firebasestorage.app",
      messagingSenderId: "134510716985",
      appId: "1:134510716985:web:68f528a74abe082e6045e8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    window.db = db;
  </script>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // =============================================================
    // VISTA #1: ORGANIZADOR (CREAR JUEGO)
    // =============================================================
    function AdminView() {
      const [players, setPlayers] = useState([]);
      const [name, setName] = useState("");
      const [loading, setLoading] = useState(false);
      const [createdGame, setCreatedGame] = useState(null); // Guarda { gameId, adminSecret }

      const addPlayer = () => {
        if (name.trim() && !players.includes(name.trim())) {
          setPlayers([...players, name.trim()]);
          setName("");
        }
      };
      
      const removePlayer = (playerToRemove) => {
        setPlayers(players.filter(p => p !== playerToRemove));
      };
      
      const generateId = (length) => Math.random().toString(36).substring(2, length + 2).toUpperCase();

      const createGame = async () => {
        if (players.length < 2) return alert("Necesitas al menos 2 jugadores");
        setLoading(true);

        const newGameId = generateId(6);
        const adminSecret = generateId(10); // <-- NUEVO: Código secreto del admin
        
        // --- Lógica del sorteo (robusta) ---
        let givers = [...players];
        let receivers = [...players];
        const finalAssignments = {};
        for (const giver of givers) {
          let possibleReceivers = receivers.filter(r => r !== giver);
          if (possibleReceivers.length === 0) { // Caso especial: el último se saca a sí mismo
            const randomGiver = players[0]; 
            const randomGiverTarget = finalAssignments[randomGiver];
            finalAssignments[randomGiver] = giver; 
            finalAssignments[giver] = randomGiverTarget;
            break;
          }
          let receiver = possibleReceivers[Math.floor(Math.random() * possibleReceivers.length)];
          finalAssignments[giver] = receiver;
          receivers = receivers.filter(r => r !== receiver); 
        }
        // --- Fin del sorteo ---

        try {
          const batch = db.batch();
          
          // 1. Creamos el documento principal del juego
          batch.set(db.collection("juegos").doc(newGameId), { 
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              playerCount: players.length,
              adminSecret: adminSecret,  // <-- NUEVO: Guardamos el secreto del admin
              finalReveal: false       // <-- NUEVO: Controla la revelación final
          });
          
          // 2. Creamos los documentos de cada participante
          for (const [giver, receiver] of Object.entries(finalAssignments)) {
            const playerDocRef = db.collection("juegos").doc(newGameId).collection("participantes").doc(giver);
            batch.set(playerDocRef, {
              nombre: giver,
              leTocaA: receiver,
              revelado: false,
              wishlist: ""  // <-- NUEVO: Campo para la lista de deseos
            });
          }
          
          await batch.commit();
          setLoading(false);
          setCreatedGame({ gameId: newGameId, adminSecret: adminSecret }); // Mostramos la pantalla de éxito

        } catch (error) {
          console.error("Error al crear el juego:", error);
          alert("Hubo un error al crear el juego. Intenta de nuevo.");
          setLoading(false);
        }
      };
      
      // --- Pantalla de Éxito (¡AHORA MUESTRA 2 LINKS!) ---
      if (createdGame) {
        const baseUrl = window.location.href.split('?')[0];
        const shareLink = `${baseUrl}?juego=${createdGame.gameId}`;
        const adminLink = `${baseUrl}?juego=${createdGame.gameId}&admin=${createdGame.adminSecret}`;
        
        return (
          <div className="bg-white shadow-xl rounded-2xl p-6 w-full space-y-4">
            <h1 className="text-2xl font-bold text-center mb-2">🎁 Amigo Secreto Virtual</h1>
            <div className="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded-lg">
              <p className="font-bold">¡Sorteo creado exitosamente!</p>
              <p>Código del juego: <span className="font-mono text-lg">{createdGame.gameId}</span></p>
            </div>
            
            <div>
              <p className="font-semibold mb-2">Paso 2: Comparte este link con todos:</p>
              <div className="flex gap-2">
                <input type="text" readOnly value={shareLink} className="border p-2 flex-grow rounded-lg bg-gray-100"/>
                <button onClick={() => navigator.clipboard.writeText(shareLink)} className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Copiar</button>
              </div>
            </div>

            {/* --- NUEVO: LINK DE ADMINISTRADOR --- */}
            <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg">
              <p className="font-bold">🚨 ¡SOLO PARA TI! (Link de Admin)</p>
              <p className="text-sm mb-2">Guarda este link secreto. Te servirá para revelar todos los nombres al final del juego.</p>
              <div className="flex gap-2">
                <input type="text" readOnly value={adminLink} className="border p-2 flex-grow rounded-lg bg-gray-100"/>
                <button onClick={() => navigator.clipboard.writeText(adminLink)} className="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700">Copiar</button>
              </div>
            </div>
            
             <a href={shareLink} className="block w-full text-center bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 mt-4">
                Continuar para ver mi asignación
            </a>
          </div>
        );
      }
      
      // --- Pantalla de Creación (Formulario) ---
      return (
        <div className="bg-white shadow-xl rounded-2xl p-6 w-full">
          <h1 className="text-2xl font-bold text-center mb-4">🎁 Amigo Secreto Virtual</h1>
          <p className="text-center text-gray-600 mb-4">Paso 1: Agrega a los participantes y crea el juego.</p>
          <div className="flex gap-2 mb-4">
            <input
              className="border p-2 flex-grow rounded-lg" type="text" placeholder="Nombre del participante"
              value={name} onChange={(e) => setName(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && addPlayer()}
            />
            <button onClick={addPlayer} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
              Agregar
            </button>
          </div>
          <div className="mb-4 min-h-[100px]">
            <h2 className="font-semibold">👥 Jugadores: ({players.length})</h2>
            <ul className="list-disc ml-6 mt-2">
              {players.map((p) => (
                <li key={p} className="flex justify-between items-center">
                  {p}
                  <button onClick={() => removePlayer(p)} className="text-red-500 hover:text-red-700 text-xs">(quitar)</button>
                </li>
              ))}
            </ul>
          </div>
          <button onClick={createGame} disabled={loading || players.length < 2} className="bg-green-600 text-white w-full py-2 rounded-lg hover:bg-green-700 disabled:opacity-50">
            {loading ? "Creando juego..." : `🎲 Crear Sorteo (${players.length} jugadores)`}
          </button>
        </div>
      );
    }

    // =============================================================
    // VISTA #2: PARTICIPANTE (VER ASIGNACIÓN Y WISHLIST)
    // =============================================================
    function ParticipantView({ gameId }) {
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      
      // Lista de jugadores que no han revelado su nombre
      const [unclaimedPlayers, setUnclaimedPlayers] = useState([]);
      const [selectedName, setSelectedName] = useState("");
      
      // Datos guardados del usuario
      const [myIdentity, setMyIdentity] = useState(null); // { myName, myTarget }
      
      // Datos de la Lista de Deseos
      const [myWishlist, setMyWishlist] = useState(""); // Mi lista
      const [targetWishlist, setTargetWishlist] = useState(null); // La lista de mi amigo secreto
      const [savingWishlist, setSavingWishlist] = useState(false);
      
      const storageKey = 'amigoSecreto-' + gameId;

      // Cargar datos al iniciar
      useEffect(() => {
        // 1. Revisa si el usuario ya se había identificado
        const storedIdentity = localStorage.getItem(storageKey);
        if (storedIdentity) {
          const data = JSON.parse(storedIdentity);
          setMyIdentity(data);
          // Carga la lista de deseos de este usuario
          fetchMyWishlist(data.myName);
          // Carga la lista de deseos del amigo secreto
          fetchTargetWishlist(data.myTarget);
          setLoading(false);
        } else {
          // 2. Si no, carga la lista de jugadores que faltan
          fetchUnclaimedPlayers();
        }
      }, [gameId]);

      // Función para buscar jugadores que no han visto su nombre
      const fetchUnclaimedPlayers = () => {
        setLoading(true);
        db.collection("juegos").doc(gameId).collection("participantes").where("revelado", "==", false)
          .get().then(snapshot => {
            if (snapshot.empty) {
              setError("Este juego no existe o ya todos han visto su nombre.");
            }
            const playerList = snapshot.docs.map(doc => doc.data().nombre);
            setUnclaimedPlayers(playerList);
            setLoading(false);
          }).catch(err => {
            setError("No se pudo cargar el juego. Verifica el código.");
            setLoading(false);
          });
      };
      
      // Función para buscar MI lista de deseos
      const fetchMyWishlist = async (myName) => {
         try {
            const doc = await db.collection("juegos").doc(gameId).collection("participantes").doc(myName).get();
            if(doc.exists) setMyWishlist(doc.data().wishlist || "");
         } catch(e) {/* no-op */}
      };

      // Función para buscar la lista de deseos de MI AMIGO SECRETO
      const fetchTargetWishlist = async (targetName) => {
         try {
            const doc = await db.collection("juegos").doc(gameId).collection("participantes").doc(targetName).get();
            if(doc.exists) setTargetWishlist(doc.data().wishlist || "");
         } catch(e) { setTargetWishlist(""); } // Pone "" si hay error
      };

      // Función para revelar el amigo secreto por primera vez
      const revealMyName = async () => {
        if (!selectedName) return alert("Por favor, selecciona tu nombre de la lista.");
        setLoading(true);

        const playerDocRef = db.collection("juegos").doc(gameId).collection("participantes").doc(selectedName);

        try {
          const targetName = await db.runTransaction(async (transaction) => {
            const doc = await transaction.get(playerDocRef);
            if (!doc.exists) throw "¡Tu nombre no se encontró en este juego!";
            if (doc.data().revelado) throw "¡Este nombre ya fue seleccionado por alguien más!";
            
            transaction.update(playerDocRef, { revelado: true });
            return doc.data().leTocaA;
          });
          
          // ¡Éxito! Guarda la identidad en el navegador
          const identity = { myName: selectedName, myTarget: targetName };
          localStorage.setItem(storageKey, JSON.stringify(identity));
          
          setMyIdentity(identity); // Guarda en el estado
          fetchTargetWishlist(targetName); // Busca la wishlist del objetivo
          setLoading(false);
          
        } catch (e) {
          setError(typeof e === 'string' ? e : "Hubo un error al consultar. Intenta de nuevo.");
          setLoading(false);
          // Si falla, refrescamos la lista de jugadores por si alguien más lo tomó
          fetchUnclaimedPlayers();
        }
      };

      // --- NUEVO: Función para guardar MI lista de deseos ---
      const saveWishlist = async () => {
        if (!myIdentity) return;
        setSavingWishlist(true);
        try {
          await db.collection("juegos").doc(gameId).collection("participantes").doc(myIdentity.myName).update({
            wishlist: myWishlist
          });
          alert("¡Lista de deseos guardada!");
        } catch (error) {
          alert("Error al guardar la lista.");
        }
        setSavingWishlist(false);
      };

      // --- PANTALLA DE CARGA ---
      if (loading && !myIdentity) {
          return (
             <div className="bg-white shadow-xl rounded-2xl p-6 w-full text-center">
                <p className="text-lg text-gray-700">Cargando juego...</p>
             </div>
           );
      }
      
      // --- PANTALLA DE ERROR ---
      if (error) {
           return (
             <div className="bg-white shadow-xl rounded-2xl p-6 w-full text-center">
                <h1 className="text-2xl font-bold text-red-600 mb-4">Error</h1>
                <p className="text-gray-700">{error}</p>
                <a href={window.location.href.split('?')[0]} className="block text-blue-600 mt-4">Volver a la página principal</a>
             </div>
           );
      }
      
      // --- PANTALLA #1: SELECCIONAR NOMBRE (Si no está en localStorage) ---
      if (!myIdentity) {
        return (
          <div className="bg-white shadow-xl rounded-2xl p-6 w-full">
            <h1 className="text-2xl font-bold text-center mb-4">🎁 Amigo Secreto</h1>
            <p className="text-center text-gray-600 mb-4">Selecciona tu nombre de la lista para descubrir quién te tocó.</p>
            <select className="border p-2 w-full rounded-lg mb-4" value={selectedName} onChange={(e) => setSelectedName(e.target.value)}>
              <option value="">-- Por favor, elige tu nombre --</option>
              {unclaimedPlayers.map(p => (<option key={p} value={p}>{p}</option>))}
            </select>
            <button onClick={revealMyName} disabled={loading || !selectedName} className="bg-red-600 text-white w-full py-2 rounded-lg hover:bg-red-700 disabled:opacity-50">
              {loading ? "..." : "¡Revelar mi amigo secreto!"}
            </button>
          </div>
        );
      }
      
      // --- PANTALLA #2: MOSTRAR RESULTADO (Si ya está en localStorage) ---
      return (
        <div className="bg-white shadow-xl rounded-2xl p-6 w-full space-y-6">
           {/* --- 1. Tu resultado --- */}
           <div className="text-center">
             <h1 className="text-2xl font-bold text-center mb-2">🎁 Amigo Secreto</h1>
             <p className="text-lg text-gray-700">¡Hola, <span className="font-bold">{myIdentity.myName}</span>!</p>
             <p className="text-lg text-gray-700 mt-4">Te toca darle un regalo a...</p>
             <div className="my-4 p-4 bg-blue-100 rounded-lg">
                <p className="text-4xl font-bold text-blue-700">{myIdentity.myTarget}</p>
             </div>
           </div>
           
           {/* --- 2. Lista de deseos de tu amigo secreto --- */}
           <div className="border-t pt-4">
              <h2 className="font-semibold text-lg mb-2">💡 Lista de deseos de {myIdentity.myTarget}:</h2>
              {targetWishlist === null ? (
                <p className="text-sm text-gray-500">Cargando lista...</p>
              ) : (
                <div className="bg-gray-100 p-3 rounded-lg min-h-[50px]">
                  <p className="text-gray-700 whitespace-pre-wrap">{targetWishlist || "(Aún no ha escrito su lista. ¡Revisa esta página más tarde!)"}</p>
                </div>
              )}
           </div>

           {/* --- 3. Formulario para TU lista de deseos --- */}
           <div className="border-t pt-4">
              <h2 className="font-semibold text-lg mb-2">📝 Ayuda a tu amigo secreto:</h2>
              <p className="text-sm text-gray-600 mb-2">Escribe aquí tu lista de deseos o pistas para que la persona que te regala a TI sepa qué darte.</p>
              <textarea
                className="border p-2 w-full rounded-lg"
                rows="3"
                placeholder="Ej: Me gustan los chocolates, talla M, etc."
                value={myWishlist}
                onChange={(e) => setMyWishlist(e.target.value)}
              />
              <button
                onClick={saveWishlist}
                disabled={savingWishlist}
                className="bg-green-600 text-white w-full py-2 rounded-lg hover:bg-green-700 mt-2 disabled:opacity-50"
              >
                {savingWishlist ? "Guardando..." : "Guardar mi lista"}
              </button>
           </div>
        </div>
      );
    }
        // =============================================================
    // VISTA #3: ADMIN (PÁGINA SECRETA DE REVELACIÓN)
    // =============================================================
    function AdminRevealView({ gameId, adminSecret }) {
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState(null);
        
        const revealAll = async () => {
            if (!confirm("¿Estás seguro?\nEsto revelará todos los nombres a todos los participantes. Esta acción no se puede deshacer.")) {
                return;
            }
            setLoading(true);
            try {
                await db.collection("juegos").doc(gameId).update({ finalReveal: true });
                alert("¡Revelación exitosa! Todos los jugadores ahora pueden ver los resultados.");
                window.location.reload(); // Recarga la página para mostrar la vista final
            } catch(e) {
                setError("No se pudo activar la revelación.");
                setLoading(false);
            }
        };

        return (
          <div className="bg-white shadow-xl rounded-2xl p-6 w-full text-center">
            <h1 className="text-2xl font-bold text-yellow-600 mb-4">🔐 Panel de Administrador</h1>
            <p className="text-gray-700 mb-4">Estás a punto de finalizar el juego. Al presionar este botón, todos los participantes podrán ver la lista completa de "quién le regaló a quién".</p>
            <p className="text-gray-700 font-semibold mb-6">Úsalo solo cuando el intercambio de regalos haya terminado.</p>
            
            <button
              onClick={revealAll}
              disabled={loading}
              className="bg-red-600 text-white w-full py-3 rounded-lg hover:bg-red-700 text-lg font-bold disabled:opacity-50"
            >
              {loading ? "..." : "¡REVELAR TODOS AHORA!"}
            </button>
            {error && <p className="text-red-500 mt-4">{error}</p>}
          </div>
        );
    }
    
    // =============================================================
    // VISTA #4: REVELACIÓN FINAL (TODOS VEN ESTO)
    // =============================================================
    function FinalRevealView({ gameId }) {
        const [loading, setLoading] = useState(true);
        const [assignments, setAssignments] = useState([]);
        
        useEffect(() => {
            db.collection("juegos").doc(gameId).collection("participantes").get()
                .then(snapshot => {
                    const allPairs = snapshot.docs.map(doc => doc.data());
                    setAssignments(allPairs);
                    setLoading(false);
                });
        }, [gameId]);

        return (
          <div className="bg-white shadow-xl rounded-2xl p-6 w-full">
            <h1 className="text-2xl font-bold text-center mb-4">🎉 ¡Resultados Finales!</h1>
            <p className="text-center text-gray-600 mb-4">¡El juego ha terminado! Aquí están todas las parejas:</p>
            
            {loading ? (
                <p>Cargando resultados...</p>
            ) : (
                <ul className="list-none space-y-2">
                    {assignments.map(p => (
                        <li key={p.nombre} className="p-3 bg-gray-100 rounded-lg flex items-center justify-center">
                            <span className="font-bold text-blue-600">{p.nombre}</span>
                            <span className="mx-3 text-gray-500">→</span>
                            <span className="font-bold text-green-600">{p.leTocaA}</span>
                        </li>
                    ))}
                </ul>
            )}
             <a href={window.location.href.split('?')[0]} className="block text-center text-blue-600 mt-6">Crear un nuevo juego</a>
          </div>
        );
    }

    // =============================================================
    // APP PRINCIPAL (ROUTER: Decide qué vista mostrar)
    // =============================================================
    function App() {
      const [view, setView] = useState('loading'); // 'loading', 'adminCreate', 'participant', 'adminReveal', 'finalReveal', 'error'
      const [gameId, setGameId] = useState(null);
      const [adminSecret, setAdminSecret] = useState(null);

      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const game = params.get('juego');
        const admin = params.get('admin');

        if (game) {
          setGameId(game);
          if (admin) setAdminSecret(admin);

          db.collection("juegos").doc(game).get()
            .then(doc => {
              if (!doc.exists) {
                setView('error');
                return;
              }
              const gameData = doc.data();
              
              if (gameData.finalReveal === true) {
                setView('finalReveal');
              } else if (admin && admin === gameData.adminSecret) {
                setView('adminReveal');
              } else {
                setView('participant');
              }
            })
            .catch(err => setView('error'));
        } else {
          setView('adminCreate'); // No hay 'juego', muestra la página de creación
        }
      }, []);

      // Renderiza la vista correcta según el estado
      switch (view) {
        case 'loading':
          return <div className="text-center p-6"><p>Cargando...</p></div>;
        case 'adminCreate':
          return <AdminView />;
        case 'participant':
          return <ParticipantView gameId={gameId} />;
        case 'adminReveal':
          return <AdminRevealView gameId={gameId} adminSecret={adminSecret} />;
        case 'finalReveal':
          return <FinalRevealView gameId={gameId} />;
        case 'error':
        default:
          return (
             <div className="bg-white shadow-xl rounded-2xl p-6 w-full text-center">
                <h1 className="text-2xl font-bold text-red-600 mb-4">Error</h1>
                <p className="text-gray-700">El juego que buscas no existe o el link es incorrecto.</p>
                <a href={window.location.href.split('?')[0]} className="block text-blue-600 mt-4">Crear un juego nuevo</a>
             </div>
          );
      }
    }

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>
